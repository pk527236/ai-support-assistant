name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        # Create .ssh directory if it doesn't exist
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Save private key to file
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Add EC2 to known hosts
        ssh-keyscan -H $HOST >> ~/.ssh/known_hosts 2>/dev/null
        chmod 644 ~/.ssh/known_hosts
        
        # Deploy via SSH
        ssh -i private_key.pem -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Navigate to app directory
          cd ~/ai-support-bot || {
            echo "‚ùå App directory not found!"
            exit 1
          }
          
          # Backup frontend before pulling
          echo "üíæ Backing up frontend..."
          if [ -f /var/www/dvsum-bot/index.html ]; then
            sudo cp /var/www/dvsum-bot/index.html /tmp/index.html.backup
            echo "‚úÖ Frontend backed up to /tmp/index.html.backup"
          fi
          
          # Store current commit hash
          CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
          
          # Pull latest code
          echo "üì• Pulling latest changes..."
          git fetch origin
          NEW_COMMIT=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null)
          
          if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
            echo "‚ÑπÔ∏è No new commits. Skipping update."
          else
            echo "üîÑ New commits detected. Updating..."
            git pull origin main || git pull origin master
          fi
          
          # Check if requirements.txt changed
          REQUIREMENTS_CHANGED=false
          if [ "$CURRENT_COMMIT" != "none" ]; then
            if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "requirements.txt"; then
              REQUIREMENTS_CHANGED=true
              echo "üì¶ requirements.txt changed - will update dependencies"
            else
              echo "‚úÖ requirements.txt unchanged - skipping dependency installation"
            fi
          else
            REQUIREMENTS_CHANGED=true
            echo "üì¶ First deployment - will install dependencies"
          fi
          
          # Update .env file with secrets
          echo "üîß Updating environment variables..."
          cat > .env << EOF
GROQ_API_KEY=$GROQ_API_KEY
FRESHSERVICE_DOMAIN=yourcompany.freshservice.com
FRESHSERVICE_API_KEY=your_api_key_here
EOF
          
          # Activate virtual environment or create if not exists
          if [ ! -d venv ]; then
            echo "üêç Creating virtual environment..."
            python3 -m venv venv
            REQUIREMENTS_CHANGED=true
          fi
          
          source venv/bin/activate
          
          # Install/Update dependencies only if requirements.txt changed
          if [ "$REQUIREMENTS_CHANGED" = true ]; then
            echo "üì¶ Installing/Updating dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "‚è© Skipping dependency installation (no changes)"
          fi
          
          # Check if data directory exists
          if [ ! -d data ]; then
            echo "üìÅ Creating data directory..."
            mkdir -p data
          fi
          
          # Restore frontend if it was backed up
          echo "üîÑ Restoring frontend..."
          if [ -f /tmp/index.html.backup ]; then
            sudo cp /tmp/index.html.backup /var/www/dvsum-bot/index.html
            sudo chown www-data:www-data /var/www/dvsum-bot/index.html
            sudo chmod 644 /var/www/dvsum-bot/index.html
            echo "‚úÖ Frontend restored from backup"
          else
            echo "‚ÑπÔ∏è No frontend backup found - using repository version"
            # Only copy if frontend doesn't exist
            if [ ! -f /var/www/dvsum-bot/index.html ]; then
              sudo cp index.html /var/www/dvsum-bot/
              sudo chown www-data:www-data /var/www/dvsum-bot/index.html
              sudo chmod 644 /var/www/dvsum-bot/index.html
            fi
          fi
          
          # Restart the Flask app using systemd
          echo "üîÑ Restarting application..."
          sudo systemctl restart dvsum-bot.service
          
          # Wait for service to start
          sleep 3
          
          # Check application status
          echo "‚úÖ Checking application status..."
          sudo systemctl is-active dvsum-bot.service && echo "‚úÖ Service is running" || {
            echo "‚ùå Service failed to start"
            sudo journalctl -u dvsum-bot.service -n 20 --no-pager
            exit 1
          }
          
          # Verify health endpoint
          echo "üè• Checking health endpoint..."
          if curl -f http://localhost:5000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed (service may still be starting)"
          fi
          
          echo ""
          echo "‚úÖ Deployment completed successfully!"
          echo "üìä Deployment summary:"
          echo "  - Commit: $NEW_COMMIT"
          echo "  - Dependencies updated: $REQUIREMENTS_CHANGED"
          echo "  - Frontend: Preserved EC2 version"
        ENDSSH
        
        # Cleanup
        rm -f private_key.pem
    
    - name: Deployment Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Deployment failed!"
          exit 1
        fi