- name: Deploy to EC2
  env:
    PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
    HOST: ${{ secrets.EC2_HOST }}
    USER: ${{ secrets.EC2_USER }}
    GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

  run: |
    echo "$PRIVATE_KEY" > private_key.pem
    chmod 600 private_key.pem

    # â­ FIX: create ssh folder first
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

    ssh -i private_key.pem -o StrictHostKeyChecking=no $USER@$HOST << ENDSSH
    set -e

    echo "ðŸš€ Starting deployment..."

    mkdir -p ~/ai-support-bot
    cd ~/ai-support-bot

    if [ -d .git ]; then
      git pull origin main || git pull origin master
    else
      git clone https://github.com/${{ github.repository }} .
    fi

    printf "GROQ_API_KEY=%s\nFRESHSERVICE_DOMAIN=%s\nFRESHSERVICE_API_KEY=%s\n" \
    "$GROQ_API_KEY" \
    "yourcompany.freshservice.com" \
    "your_api_key_here" > .env

    if [ ! -d venv ]; then
      python3 -m venv venv
    fi

    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt

    mkdir -p data

    sudo systemctl restart dvsum-bot.service || true

    echo "âœ… Deployment finished"
    ENDSSH

    rm -f private_key.pem
